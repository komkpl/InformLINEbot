name: Send LINE Message Every 2 Weeks

on:
  schedule:
    - cron: "0 22 * * 1"   # 毎週月曜 22:00 UTC (+9hrs for JST)
  workflow_dispatch:

jobs:
  send_message:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Skip unless biweekly from 2025-11-25
        run: |
          START_DATE="2025-11-24"

          # 今日の日付（UTC）
          TODAY=$(date -u +"%Y-%m-%d")

          # START_DATE と TODAY の日数差
          DIFF=$(( ( $(date -d "$TODAY" +%s) - $(date -d "$START_DATE" +%s) ) / 86400 ))

          # 14日周期（隔週）で実行する
          if [ $((DIFF % 14)) -ne 0 ]; then
            echo "Not the scheduled biweekly run. Skipping job."
            exit 0
          fi

          echo "This is the correct biweekly run. Continuing..."
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------
      # Google credentials.json を作る
      # -------------------------
      - name: Create Google credentials.json
        run: |
          echo "${GOOGLE_CREDENTIALS}" > credentials.json
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Install Google API client
        run: npm install googleapis@105

      # -------------------------
      # スプレッドシートから名前取得
      # -------------------------
      - name: Read names from Google Sheets
        id: sheet
        run: |
          node <<'EOF'
          const { google } = require("googleapis");
          const fs = require("fs");

          //  credentials.json を読み込み
          const auth = new google.auth.GoogleAuth({
            keyFile: "credentials.json",
            scopes: ["https://www.googleapis.com/auth/spreadsheets"],
          });

          const sheets = google.sheets({ version: "v4", auth });

          async function main() {
            const res = await sheets.spreadsheets.values.get({
              spreadsheetId: process.env.SHEET_ID,
              range: "A:A",
            });

            const names = res.data.values.flat();
            console.log("Names:", names);

            const current = names[0];
            const previous = names[names.length - 1];

            console.log(`::set-output name=current::${current}`);
            console.log(`::set-output name=previous::${previous}`);

            // rotate
            const rotated = [...names.slice(1), names[0]];
            fs.writeFileSync("rotated.json", JSON.stringify(rotated));
          }

          main();
          EOF
        env:
          SHEET_ID: ${{ secrets.SHEET_ID }}

      # -------------------------
      # スプレッドシートに書き戻し
      # -------------------------
      - name: Update Google Sheets (rotate)
        run: |
          node <<'EOF'
          const { google } = require("googleapis");
          const rotated = require("./rotated.json");

          const auth = new google.auth.GoogleAuth({
            keyFile: "credentials.json",
            scopes: ["https://www.googleapis.com/auth/spreadsheets"],
          });

          const sheets = google.sheets({ version: "v4", auth });

          async function main() {
            await sheets.spreadsheets.values.update({
              spreadsheetId: process.env.SHEET_ID,
              range: "A1",
              valueInputOption: "RAW",
              requestBody: {
                values: rotated.map(n => [n]),
              },
            });

            console.log("Spreadsheet updated.");
          }
          main();
          EOF
        env:
          SHEET_ID: ${{ secrets.SHEET_ID }}

      # -------------------------
      # 日付範囲の生成
      # -------------------------
      - name: Generate date range
        id: range
        run: |
          START_DATE=$(date -d "+1 day")
          END_DATE=$(date -d "$START_DATE +13 days")

          # 日本語曜日
          jp_weekday() {
            case "$1" in
              0) echo "日" ;;
              1) echo "月" ;;
              2) echo "火" ;;
              3) echo "水" ;;
              4) echo "木" ;;
              5) echo "金" ;;
              6) echo "土" ;;
            esac
          }

          # 英語曜日
          en_weekday() {
            case "$1" in
              0) echo "Sun" ;;
              1) echo "Mon" ;;
              2) echo "Tue" ;;
              3) echo "Wed" ;;
              4) echo "Thu" ;;
              5) echo "Fri" ;;
              6) echo "Sat" ;;
            esac
          }

          S_MMDD=$(date -d "$START_DATE" +%m/%d)
          S_WD_JP=$(jp_weekday $(date -d "$START_DATE" +%w))
          S_WD_EN=$(en_weekday $(date -d "$START_DATE" +%w))

          E_MMDD=$(date -d "$END_DATE" +%m/%d)
          E_WD_JP=$(jp_weekday $(date -d "$END_DATE" +%w))
          E_WD_EN=$(en_weekday $(date -d "$END_DATE" +%w))

          RANGE_JP="${S_MMDD}(${S_WD_JP}) 〜 ${E_MMDD}(${E_WD_JP})"
          RANGE_EN="${S_MMDD}(${S_WD_EN}) - ${E_MMDD}(${E_WD_EN})"

          echo "range_jp=$RANGE_JP" >> $GITHUB_OUTPUT
          echo "range_en=$RANGE_EN" >> $GITHUB_OUTPUT

      # -------------------------
      # LINE メッセージ送信
      # -------------------------
      - name: Send LINE message
        run: |
          CURRENT="${{ steps.sheet.outputs.current }}"
          PREVIOUS="${{ steps.sheet.outputs.previous }}"
          RANGE_JP="${{ steps.range.outputs.range_jp }}"

          JP1="${RANGE_JP} のゴミ捨て当番は ${CURRENT} さんです！"
          JP2="${PREVIOUS} さんは、すべてのゴミを出しておいてください！"

          EN1="Garbage duty for the period ${RANGE_EN} is assigned to ${CURRENT}."
          EN2="${PREVIOUS}, please make sure all trash is taken out."

          cat <<EOF > body.json
          {
            "to": "${{ secrets.LINE_GROUP_ID }}",
            "messages": [
              {
                "type": "text",
                "text": "${JP1}\n\n${JP2}\n\n${EN1}\n\n${EN2}"
              }
            ]
          }
          EOF

          curl -X POST https://api.line.me/v2/bot/message/push \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINE_ACCESS_TOKEN }}" \
            -d @body.json