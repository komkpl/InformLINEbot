name: Send LINE Message Every 2 Weeks

on:
  schedule:
    - cron: "0 22 * * 2"
  workflow_dispatch:

jobs:
  send_message:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Load names from secret JSON
        id: names
        run: |
          echo "Loaded names: $NAMES_JSON"

          # jq が使えるか確認
          sudo apt-get update -y
          sudo apt-get install -y jq

          # Secret JSON を配列として読み込む
          echo "$NAMES_JSON" | jq . > names.json

          CURRENT=$(jq -r '.[0]' names.json)
          PREVIOUS=$(jq -r '.[-1]' names.json)

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT

          # ローテーション処理
          ROTATED=("${NAMES[@]:1}" "${NAMES[0]}")

          # 新しい JSON に戻す
          NEW_JSON=$(printf '%s\n' "${ROTATED[@]}" | jq -R . | jq -s .)

          echo "new_json=$NEW_JSON" >> "$GITHUB_OUTPUT"
      - name: Save new rotated names back to secret (via GitHub API)
        run: |
          NEW_JSON='${{ steps.names.outputs.new_json }}'
          echo "$NEW_JSON"

          # GitHub API を使って secret を更新
          curl -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/secrets/NAMES_JSON \
            -d "{\"encrypted_value\":\"$(echo -n "$NEW_JSON" | base64)\",\"key_id\":\"$(curl -s -H \"Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}\" https://api.github.com/repos/${{ github.repository }}/actions/secrets/public-key | jq -r .key_id)\"}"
      
      - name: Send LINE message (JP + EN with date range)
        run: |
          CURRENT="${{ steps.names_before.outputs.current }}"
          PREVIOUS="${{ steps.names_before.outputs.previous }}"
          RANGE_JP="${{ steps.daterange.outputs.range_jp }}"

          JP1="${RANGE_JP} のゴミ捨て当番は ${CURRENT} さんです！"
          JP2="${PREVIOUS} さんは、すべてのゴミを出しておいてください！"
          EN1="Garbage duty for the period ${RANGE_JP} is assigned to ${CURRENT}."
          EN2="${PREVIOUS}, please make sure all the trash is taken out."

          cat <<EOF > body.json
          {
            "to": "${{ secrets.LINE_GROUP_ID }}",
            "messages": [
              {
                "type": "text",
                "text": "${JP1}\n\n${JP2}\n\n${EN1}\n\n${EN2}"
              }
            ]
          }
          EOF

          curl -v -X POST https://api.line.me/v2/bot/message/push \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINE_ACCESS_TOKEN }}" \
            -d @body.json