name: Send LINE Message Every 2 Weeks

on:
  schedule:
    - cron: "0 22 * * 2"   # JST 水曜 7:00
  workflow_dispatch:

jobs:
  send_message:
    runs-on: ubuntu-latest

    steps:
      - name: Setup jq and libsodium
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq libsodium23

      - name: Load names from secret
        id: load
        run: |
          echo "Loaded JSON: $NAMES_JSON"

          echo "$NAMES_JSON" > names.json

          CURRENT=$(jq -r '.[0]' names.json)
          PREVIOUS=$(jq -r '.[-1]' names.json)

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT

          # ---- rotation ----
          NEW_JSON=$(jq '.[1:] + [.[0]]' names.json)
          echo "new_json=$NEW_JSON" >> $GITHUB_OUTPUT

      - name: Encrypt rotated JSON for GitHub secrets
        id: encrypt
        run: |
          PUB_INFO=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/secrets/public-key)

          KEY_ID=$(echo "$PUB_INFO" | jq -r .key_id)
          PUBLIC_KEY=$(echo "$PUB_INFO" | jq -r .key)

          echo "key_id=$KEY_ID" >> $GITHUB_OUTPUT

          NEW_JSON='${{ steps.load.outputs.new_json }}'

          # libsodium で暗号化（base64）
          ENCRYPTED=$(echo -n "$NEW_JSON" | \
            openssl enc -aes-256-cbc -a -salt -pass pass:"$PUBLIC_KEY")

          echo "encrypted=$ENCRYPTED" >> $GITHUB_OUTPUT

      - name: Save updated secret back to GitHub
        run: |
          curl -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/secrets/NAMES_JSON \
            -d "{
              \"encrypted_value\": \"${{ steps.encrypt.outputs.encrypted }}\",
              \"key_id\": \"${{ steps.encrypt.outputs.key_id }}\"
            }"

      - name: Generate date range
        id: range
        run: |
          START_DATE=$(date -d "+1 day" +%Y-%m-%d)
          END_DATE=$(date -d "$START_DATE +13 days" +%Y-%m-%d)

          # 日本語曜日
          get_jp_weekday() {
            case "$1" in
              0) echo "日" ;;
              1) echo "月" ;;
              2) echo "火" ;;
              3) echo "水" ;;
              4) echo "木" ;;
              5) echo "金" ;;
              6) echo "土" ;;
            esac
          }

          # start (JP)
          S_MMDD_JP=$(date -d "$START_DATE" +%m/%d)
          S_WD_NUM=$(date -d "$START_DATE" +%w)
          S_WD_JP=$(get_jp_weekday $S_WD_NUM)

          # end (JP)
          E_MMDD_JP=$(date -d "$END_DATE" +%m/%d)
          E_WD_NUM=$(date -d "$END_DATE" +%w)
          E_WD_JP=$(get_jp_weekday $E_WD_NUM)

          # 日本語レンジ
          RANGE_JP="${S_MMDD_JP}(${S_WD_JP}) 〜 ${E_MMDD_JP}(${E_WD_JP})"
          echo "range_jp=$RANGE_JP" >> $GITHUB_OUTPUT

          # 英語レンジ
          RANGE_EN="$(date -d "$START_DATE" '+%m/%d(%a)') 〜 $(date -d "$END_DATE" '+%m/%d(%a)')"
          echo "range_en=$RANGE_EN" >> $GITHUB_OUTPUT

      - name: Send LINE message
        run: |
          CURRENT="${{ steps.load.outputs.current }}"
          PREVIOUS="${{ steps.load.outputs.previous }}"
          RANGE_JP="${{ steps.range.outputs.range_jp }}"

          JP1="${RANGE_JP} のゴミ捨て当番は ${CURRENT} さんです！"
          JP2="${PREVIOUS} さんは、すべてのゴミを出しておいてください！"
          EN1="Garbage duty for the period ${RANGE_EN} is assigned to ${CURRENT}."
          EN2="${PREVIOUS}, please make sure all trash is taken out."

          cat <<EOF > body.json
          {
            "to": "${{ secrets.LINE_GROUP_ID }}",
            "messages": [
              {
                "type": "text",
                "text": "${JP1}\n\n${JP2}\n\n${EN1}\n\n${EN2}"
              }
            ]
          }
          EOF

          curl -X POST https://api.line.me/v2/bot/message/push \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINE_ACCESS_TOKEN }}" \
            -d @body.json