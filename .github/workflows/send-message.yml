name: Send LINE Message Every 2 Weeks

on:
  schedule:
    - cron: '*/1 * * * *'   # ← テスト用に1分ごと
  workflow_dispatch:

jobs:
  send_message:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Rotate Names & Send Message
        env:
          LINE_TOKEN: ${{ secrets.LINE_TOKEN }}
          NAMES_JSON: ${{ secrets.NAMES_JSON }}
        run: |
          echo "Loaded names: $NAMES_JSON"

          # 名前リスト(JSON)をパース
          NAMES=$(echo $NAMES_JSON | jq -c '.')
          COUNT=$(echo $NAMES_JSON | jq 'length')

          # GitHub Actions キャッシュを使って、前回のインデックスを保持する
          CACHE_FILE="name_index.txt"
          
          if [ -f "$CACHE_FILE" ]; then
            INDEX=$(cat $CACHE_FILE)
          else
            INDEX=0
          fi

          # 現在の担当者名を取得
          NAME=$(echo $NAMES | jq -r ".[$INDEX]")

          # 次のインデックスにローテーション
          NEXT_INDEX=$(( (INDEX + 1) % COUNT ))

          echo "担当者: $NAME"
          echo $NEXT_INDEX > $CACHE_FILE

          # メッセージ送信
          curl -X POST https://notify-api.line.me/api/notify \
            -H "Authorization: Bearer $LINE_TOKEN" \
            -F "message=今週の担当は ${NAME} さんです！"