name: Send LINE Message Every 2 Weeks

on:
  schedule:
    - cron: "0 22 * * 2"   # JST 水曜 7:00
  workflow_dispatch:

jobs:
  send_message:
    runs-on: ubuntu-latest

    steps:
      - name: Setup jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
      
      - name: Prepare sodium encrypt script
        run: |
          cat << 'EOF' > encrypt_with_sodium.sh
          #!/bin/bash
          PUBLIC_KEY=$1
          PLAINTEXT=$(cat)
          PUB_KEY_BIN=$(echo "$PUBLIC_KEY" | base64 -d)
          echo -n "$PLAINTEXT" | libsodium-sealed-box --encrypt --public-key "$PUB_KEY_BIN" | base64 -w0
          EOF
          chmod +x encrypt_with_sodium.sh

      # ----------------------------------------
      #  Secret JSON 読み込み
      # ----------------------------------------
      - name: Load names from secret
        id: load
        run: |
          echo "$NAMES_JSON" > names.json

          CURRENT=$(jq -r '.[0]' names.json)
          PREVIOUS=$(jq -r '.[-1]' names.json)

          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS" >> $GITHUB_OUTPUT

          # rotation
          NEW_JSON=$(jq '.[1:] + [.[0]]' names.json)

          echo "new_json=$NEW_JSON" >> $GITHUB_OUTPUT

      # ----------------------------------------
      #  Secret を PAT で更新（公式推奨の libsodium 暗号化）
      # ----------------------------------------
      - name: Encrypt new JSON
        id: encrypt
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libsodium-dev

          PUB_INFO=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/secrets/public-key)

          PUBLIC_KEY=$(echo "$PUB_INFO" | jq -r .key)
          KEY_ID=$(echo "$PUB_INFO" | jq -r .key_id)

          echo "key_id=$KEY_ID" >> $GITHUB_OUTPUT

          NEW_JSON='${{ steps.load.outputs.new_json }}'

          # base64 decode → libsodium の sealed box で暗号化 → base64 エンコード
          echo -n "$NEW_JSON" | \
            openssl base64 -d 2>/dev/null || true

          # 暗号化（libsodium sealed box）
          ENCRYPTED=$(echo -n "$NEW_JSON" | \
            ./encrypt_with_sodium.sh "$PUBLIC_KEY")

          echo "encrypted_value=$ENCRYPTED" >> $GITHUB_OUTPUT

      - name: Save rotated JSON back to secret
        run: |
          curl -X PUT \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/secrets/NAMES_JSON \
            -d "{
              \"encrypted_value\": \"${{ steps.encrypt.outputs.encrypted_value }}\",
              \"key_id\": \"${{ steps.encrypt.outputs.key_id }}\"
            }"

      # ----------------------------------------
      #  日本語と英語の曜日を別で生成
      # ----------------------------------------
      - name: Generate date range
        id: range
        run: |
          START_DATE=$(date -d "+1 day")

          END_DATE=$(date -d "$START_DATE +13 days")

          # 日本語曜日
          jp_weekday() {
            case "$1" in
              0) echo "日" ;;
              1) echo "月" ;;
              2) echo "火" ;;
              3) echo "水" ;;
              4) echo "木" ;;
              5) echo "金" ;;
              6) echo "土" ;;
            esac
          }

          S_MMDD=$(date -d "$START_DATE" +%m/%d)
          S_WD=$(jp_weekday $(date -d "$START_DATE" +%w))

          E_MMDD=$(date -d "$END_DATE" +%m/%d)
          E_WD=$(jp_weekday $(date -d "$END_DATE" +%w))

          RANGE_JP="${S_MMDD}(${S_WD}) 〜 ${E_MMDD}(${E_WD})"

          echo "range_jp=$RANGE_JP" >> $GITHUB_OUTPUT

      - name: Fix previous name if null
        id: fixname
        run: |
          echo "$NAMES_JSON" | jq . > names.json

          LAST=$(jq -r '.[-1]' names.json)

          # previousがnullならLASTに置き換える
          PREV="${{ steps.names_before.outputs.previous }}"
          if [ "$PREV" = "null" ] || [ -z "$PREV" ]; then
            PREV="$LAST"
          fi

          echo "fixed_previous=$PREV" >> $GITHUB_OUTPUT
      # ----------------------------------------
      # LINE 送信
      # ----------------------------------------
      - name: Send LINE message (JP + EN with date range)
        run: |
          CURRENT="${{ steps.names_before.outputs.current }}"
          PREVIOUS="${{ steps.fixname.outputs.fixed_previous }}"
          RANGE_JP="${{ steps.daterange.outputs.range_jp }}"

          JP1="${RANGE_JP} のゴミ捨て当番は ${CURRENT} さんです！"
          JP2="${PREVIOUS} さんは、すべてのゴミを出しておいてください！"
          EN1="Garbage duty for the period ${RANGE_JP} is assigned to ${CURRENT}."
          EN2="${PREVIOUS}, please make sure all the trash is taken out."

          cat <<EOF > body.json
          {
            "to": "${{ secrets.LINE_GROUP_ID }}",
            "messages": [
              {
                "type": "text",
                "text": "${JP1}\n\n${JP2}\n\n${EN1}\n\n${EN2}"
              }
            ]
          }
          EOF

          curl -v -X POST https://api.line.me/v2/bot/message/push \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINE_ACCESS_TOKEN }}" \
            -d @body.json