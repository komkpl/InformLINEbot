name: Send LINE Message Every 2 Weeks

on:
  schedule:
    # GitHub Actions cron uses UTC. To run at Tuesday 07:00 JST (UTC+9), schedule
    # at Monday 22:00 UTC (day-of-week 0).
    - cron: "0 22 * * 1"   # 毎週火曜 07:00 JST
  workflow_dispatch:

jobs:
  send_message:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Skip unless biweekly from 2025-11-25
        id: skip
        run: |
          # Base date for the biweekly schedule (the first day of the cycle) in JST
          START_DATE="2025-11-25"

          # Use JST for calculations
          # START_TS/TODAY_TS are epoch seconds in Asia/Tokyo timezone
          START_TS=$(TZ=Asia/Tokyo date -d "$START_DATE" +%s)
          TODAY_TS=$(TZ=Asia/Tokyo date +%s)

          # START_DATE と TODAY の日数差（秒差を日数に変換）
          DIFF=$(( (TODAY_TS - START_TS) / 86400 ))

          # 正しい負数対応の 14 での剰余（負の剰余を正にする）
          MOD=$(( (DIFF % 14 + 14) % 14 ))

          if [ "$MOD" -ne 0 ]; then
            echo "run_biweekly=false" >> $GITHUB_OUTPUT
            echo "Not the scheduled biweekly run (JST). Remaining steps will be skipped."
          else
            echo "run_biweekly=true" >> $GITHUB_OUTPUT
            echo "This is the correct biweekly run (JST). Continuing..."
          fi
      
      - name: Setup Node
        if: steps.skip.outputs.run_biweekly == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # -------------------------
      # Google credentials.json を作る
      # -------------------------
      - name: Create Google credentials.json
        if: steps.skip.outputs.run_biweekly == 'true'
        run: |
          echo "${GOOGLE_CREDENTIALS}" > credentials.json
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}

      - name: Install Google API client
        if: steps.skip.outputs.run_biweekly == 'true'
        run: npm install googleapis@105

      # -------------------------
      # スプレッドシートから名前取得
      # -------------------------
      - name: Read names from Google Sheets
        if: steps.skip.outputs.run_biweekly == 'true'
        id: sheet
        run: |
          node <<'EOF'
          const { google } = require("googleapis");
          const fs = require("fs");

          //  credentials.json を読み込み
          const auth = new google.auth.GoogleAuth({
            keyFile: "credentials.json",
            scopes: ["https://www.googleapis.com/auth/spreadsheets"],
          });

          const sheets = google.sheets({ version: "v4", auth });

          async function main() {
            const res = await sheets.spreadsheets.values.get({
              spreadsheetId: process.env.SHEET_ID,
              range: "A:A",
            });

            const names = res.data.values.flat();
            console.log("Names:", names);

            const current = names[0];
            const previous = names[names.length - 1];

            console.log(`::set-output name=current::${current}`);
            console.log(`::set-output name=previous::${previous}`);

            // rotate
            const rotated = [...names.slice(1), names[0]];
            fs.writeFileSync("rotated.json", JSON.stringify(rotated));
          }

          main();
          EOF
        env:
          SHEET_ID: ${{ secrets.SHEET_ID }}

      # -------------------------
      # スプレッドシートに書き戻し
      # -------------------------
      - name: Update Google Sheets (rotate)
        if: steps.skip.outputs.run_biweekly == 'true'
        run: |
          node <<'EOF'
          const { google } = require("googleapis");
          const rotated = require("./rotated.json");

          const auth = new google.auth.GoogleAuth({
            keyFile: "credentials.json",
            scopes: ["https://www.googleapis.com/auth/spreadsheets"],
          });

          const sheets = google.sheets({ version: "v4", auth });

          async function main() {
            await sheets.spreadsheets.values.update({
              spreadsheetId: process.env.SHEET_ID,
              range: "A1",
              valueInputOption: "RAW",
              requestBody: {
                values: rotated.map(n => [n]),
              },
            });

            console.log("Spreadsheet updated.");
          }
          main();
          EOF
        env:
          SHEET_ID: ${{ secrets.SHEET_ID }}

      # -------------------------
      # 日付範囲の生成
      # -------------------------
      - name: Generate date range
        if: steps.skip.outputs.run_biweekly == 'true'
        id: range
        run: |
          # Generate date range in JST. START is tomorrow (JST), END is +13 days.
          START_DATE=$(TZ=Asia/Tokyo date -d "+1 day" +"%Y-%m-%d")
          END_DATE=$(TZ=Asia/Tokyo date -d "$START_DATE +13 days" +"%Y-%m-%d")

          # 日本語曜日
          jp_weekday() {
            case "$1" in
              0) echo "日" ;;
              1) echo "月" ;;
              2) echo "火" ;;
              3) echo "水" ;;
              4) echo "木" ;;
              5) echo "金" ;;
              6) echo "土" ;;
            esac
          }

          # 英語曜日
          en_weekday() {
            case "$1" in
              0) echo "Sun" ;;
              1) echo "Mon" ;;
              2) echo "Tue" ;;
              3) echo "Wed" ;;
              4) echo "Thu" ;;
              5) echo "Fri" ;;
              6) echo "Sat" ;;
            esac
          }

          S_MMDD=$(TZ=Asia/Tokyo date -d "$START_DATE" +%m/%d)
          S_WD_JP=$(jp_weekday $(TZ=Asia/Tokyo date -d "$START_DATE" +%w))
          S_WD_EN=$(en_weekday $(TZ=Asia/Tokyo date -d "$START_DATE" +%w))

          E_MMDD=$(TZ=Asia/Tokyo date -d "$END_DATE" +%m/%d)
          E_WD_JP=$(jp_weekday $(TZ=Asia/Tokyo date -d "$END_DATE" +%w))
          E_WD_EN=$(en_weekday $(TZ=Asia/Tokyo date -d "$END_DATE" +%w))

          RANGE_JP="${S_MMDD}(${S_WD_JP}) 〜 ${E_MMDD}(${E_WD_JP})"
          RANGE_EN="${S_MMDD}(${S_WD_EN}) - ${E_MMDD}(${E_WD_EN})"

          echo "range_jp=$RANGE_JP" >> $GITHUB_OUTPUT
          echo "range_en=$RANGE_EN" >> $GITHUB_OUTPUT

      # -------------------------
      # LINE メッセージ送信
      # -------------------------
      - name: Send LINE message
        if: steps.skip.outputs.run_biweekly == 'true'
        run: |
          CURRENT="${{ steps.sheet.outputs.current }}"
          PREVIOUS="${{ steps.sheet.outputs.previous }}"
          RANGE_JP="${{ steps.range.outputs.range_jp }}"
          RANGE_EN="${{ steps.range.outputs.range_en }}"

          JP1="${RANGE_JP} のゴミ捨て当番は ${CURRENT} さんです！"
          JP2="${PREVIOUS} さんは、すべてのゴミを出しておいてください！"

          EN1="Garbage duty for the period ${RANGE_EN} is assigned to ${CURRENT}."
          EN2="${PREVIOUS}, please make sure all trash is taken out."

          cat <<EOF > body.json
          {
            "to": "${{ secrets.LINE_GROUP_ID }}",
            "messages": [
              {
                "type": "text",
                "text": "${JP1}\n\n${JP2}\n\n${EN1}\n\n${EN2}"
              }
            ]
          }
          EOF

          curl -X POST https://api.line.me/v2/bot/message/push \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINE_ACCESS_TOKEN }}" \
            -d @body.json