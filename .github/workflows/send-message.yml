name: Send LINE Message Every 2 Weeks

on:
  schedule:
    - cron: "0 22 * * 2"   # 毎週火曜 22:00 JST
  workflow_dispatch:

jobs:
  send_message:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Google API クレデンシャルファイル作成
      - name: Create Google credentials
        run: |
          cat <<EOF > credentials.json
          {
            "type": "service_account",
            "project_id": "",
            "private_key_id": "",
            "private_key": "${GOOGLE_PRIVATE_KEY}",
            "client_email": "${GOOGLE_SERVICE_ACCOUNT}",
            "client_id": "",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": ""
          }
          EOF

        env:
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}

      - name: Install Google API client
        run: npm install googleapis@105

      # -------------------------
      # スプレッドシートから名前取得
      # -------------------------
      - name: Read names from Google Sheets
        id: sheet
        run: |
          node <<'EOF'
          const { google } = require("googleapis");
          const fs = require("fs");

          const auth = new google.auth.GoogleAuth({
            credentials: require("./credentials.json"),
            scopes: ["https://www.googleapis.com/auth/spreadsheets"],
          });

          const sheets = google.sheets({ version: "v4", auth });

          async function main() {
            const res = await sheets.spreadsheets.values.get({
              spreadsheetId: process.env.SHEET_ID,
              range: "A:A",         // A列に名前が入っていると仮定
            });

            const names = res.data.values.flat();
            console.log("Names:", names);

            // 先頭が current、末尾が previous
            const current = names[0];
            const previous = names[names.length - 1];

            console.log(`current=${current}`);
            console.log(`previous=${previous}`);

            // GitHub Actions に渡す
            console.log(`::set-output name=current::${current}`);
            console.log(`::set-output name=previous::${previous}`);

            // ローテーション
            const rotated = [...names.slice(1), names[0]];

            fs.writeFileSync("rotated.json", JSON.stringify(rotated));
          }

          main();
          EOF
        env:
          SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}

      # -------------------------
      # スプレッドシートに書き戻し（ローテーション結果）
      # -------------------------
      - name: Update Google Sheets (rotate)
        run: |
          node <<'EOF'
          const { google } = require("googleapis");
          const rotated = require("./rotated.json");

          const auth = new google.auth.GoogleAuth({
            credentials: require("./credentials.json"),
            scopes: ["https://www.googleapis.com/auth/spreadsheets"],
          });

          const sheets = google.sheets({ version: "v4", auth });

          async function main() {
            await sheets.spreadsheets.values.update({
              spreadsheetId: process.env.SHEET_ID,
              range: "A1",
              valueInputOption: "RAW",
              requestBody: {
                values: rotated.map(n => [n]),
              },
            });

            console.log("Spreadsheet updated.");
          }
          main();
          EOF
        env:
          SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}

      # -------------------------
      # 日付範囲の生成
      # -------------------------
      - name: Generate date range
        id: range
        run: |
          START_DATE=$(date -d "+1 day")
          END_DATE=$(date -d "$START_DATE +13 days")

          jp_weekday() {
            case "$1" in
              0) echo "日" ;;
              1) echo "月" ;;
              2) echo "火" ;;
              3) echo "水" ;;
              4) echo "木" ;;
              5) echo "金" ;;
              6) echo "土" ;;
            esac
          }

          S_MMDD=$(date -d "$START_DATE" +%m/%d)
          S_WD=$(jp_weekday $(date -d "$START_DATE" +%w))

          E_MMDD=$(date -d "$END_DATE" +%m/%d)
          E_WD=$(jp_weekday $(date -d "$END_DATE" +%w))

          RANGE_JP="${S_MMDD}(${S_WD}) 〜 ${E_MMDD}(${E_WD})"

          echo "range_jp=$RANGE_JP" >> $GITHUB_OUTPUT

      # -------------------------
      # LINEに送信
      # -------------------------
      - name: Send LINE message
        run: |
          CURRENT="${{ steps.sheet.outputs.current }}"
          PREVIOUS="${{ steps.sheet.outputs.previous }}"
          RANGE_JP="${{ steps.range.outputs.range_jp }}"

          cat <<EOF > body.json
          {
            "to": "${{ secrets.LINE_GROUP_ID }}",
            "messages": [
              {
                "type": "text",
                "text": "${RANGE_JP} のゴミ捨て当番は ${CURRENT} さんです！\n\n${PREVIOUS} さんは、すべてのゴミを出しておいてください！"
              }
            ]
          }
          EOF

          curl -X POST https://api.line.me/v2/bot/message/push \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.LINE_ACCESS_TOKEN }}" \
            -d @body.json